# AnalysisAgent ì•„í‚¤í…ì²˜

> LLM ê¸°ë°˜ ë™ì  ì½”ë“œ ìƒì„±ìœ¼ë¡œ ë°ì´í„° ë¶„ì„ì„ ìˆ˜í–‰í•˜ëŠ” ì—ì´ì „íŠ¸

## ğŸ“– ê°œìš”

AnalysisAgentëŠ” **ìì—°ì–´ ë¶„ì„ ìš”ì²­**ì„ ë°›ì•„ **Python ì½”ë“œë¥¼ ìë™ ìƒì„±/ì‹¤í–‰**í•˜ì—¬ ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

í•µì‹¬ íŠ¹ì§•:
- **ë²”ìš©ì  ë¶„ì„**: í•˜ë“œì½”ë”© ì—†ì´ ì–´ë–¤ ë¶„ì„ ì¿¼ë¦¬ë“  ëŒ€ì‘
- **ì•ˆì „í•œ ì‹¤í–‰**: Sandbox í™˜ê²½ì—ì„œ ì½”ë“œ ì‹¤í–‰
- **ìë™ ì¬ì‹œë„**: ì—ëŸ¬ ë°œìƒ ì‹œ LLMì´ ì½”ë“œ ìˆ˜ì • í›„ ì¬ì‹œë„
- **ë³€ìˆ˜ ê²€ì¦**: ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜ë§Œ ì°¸ì¡°í•˜ëŠ”ì§€ ì •ì  ë¶„ì„

---

## ğŸ”„ 4-Phase ì•„í‚¤í…ì²˜

```
ì…ë ¥: ë¶„ì„ ì¿¼ë¦¬ + ë°ì´í„°
"ê° ì¼€ì´ìŠ¤ë³„ HR í‰ê· ì„ êµ¬í•´ì¤˜"
                    â”‚
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Phase 1: Context Building ğŸ“Š    â”‚
        â”‚  DataFrame â†’ AnalysisContext     â”‚
        â”‚  (ìŠ¤í‚¤ë§ˆ, ì»¬ëŸ¼ ì •ë³´, í†µê³„)        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Phase 2: Planning ğŸ“‹            â”‚
        â”‚  LLMì´ ë¶„ì„ ê³„íš ìˆ˜ë¦½            â”‚
        â”‚  (ë‹¨ê³„ë³„ ì‘ì—…, ì˜ˆìƒ ì¶œë ¥)         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Phase 3: Execution âš™ï¸           â”‚
        â”‚  ê³„íšì— ë”°ë¼ ì½”ë“œ ìƒì„± + ì‹¤í–‰    â”‚
        â”‚  (CodeGen â†’ Validate â†’ Sandbox)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Phase 4: Result Assembly ğŸ“¦     â”‚
        â”‚  ê²°ê³¼ ì •ë¦¬ + ìºì‹±                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
ì¶œë ¥: AnalysisResult
{"status": "success", "result": {...}, "generated_code": "..."}
```

---

## ğŸ”§ í•µì‹¬ ì»´í¬ë„ŒíŠ¸

### 1. CodeGenerator (ì½”ë“œ ìƒì„±)

LLMì„ ì‚¬ìš©í•˜ì—¬ ë¶„ì„ ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```python
# í”„ë¡¬í”„íŠ¸ì— ì œê³µë˜ëŠ” ì •ë³´
- available_variables: ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜ ëª©ë¡
- data_schemas: DataFrame ìŠ¤í‚¤ë§ˆ (ì»¬ëŸ¼ëª…, íƒ€ì…, í†µê³„)
- hints: ë¶„ì„ íŒíŠ¸ (í‰ê· , ë¹„êµ, ìƒê´€ ë“±)
```

### 2. CodeValidator (ì½”ë“œ ê²€ì¦)

ìƒì„±ëœ ì½”ë“œì˜ ì•ˆì „ì„±ê³¼ ìœ íš¨ì„±ì„ ê²€ì‚¬í•©ë‹ˆë‹¤.

```python
# ê²€ì¦ í•­ëª©
- ê¸ˆì§€ íŒ¨í„´ ê²€ì‚¬ (os, subprocess, eval ë“±)
- ê¸ˆì§€ ëª¨ë“ˆ import ê²€ì‚¬
- result ë³€ìˆ˜ ì¡´ì¬ í™•ì¸
- ë³€ìˆ˜ ì°¸ì¡° ìœ íš¨ì„± ê²€ì‚¬ (NEW!)
```

### 3. SandboxExecutor (ì•ˆì „í•œ ì‹¤í–‰)

ê²©ë¦¬ëœ í™˜ê²½ì—ì„œ ì½”ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```python
# Sandbox ì œê³µ ë³€ìˆ˜
runtime_data = {
    "signals": Dict[caseid, DataFrame],  # Signal ë°ì´í„°
    "cohort": DataFrame,                  # Cohort ë©”íƒ€ë°ì´í„°
    "case_ids": List[str],               # ì¼€ì´ìŠ¤ ID ëª©ë¡
    "param_keys": List[str],             # íŒŒë¼ë¯¸í„° ëª©ë¡
    "pd": pandas,                         # pandas
    "np": numpy,                          # numpy
    "stats": scipy.stats,                 # scipy.stats
}
```

### 4. CodeExecutionEngine (ì¬ì‹œë„ ì—”ì§„)

ì—ëŸ¬ ë°œìƒ ì‹œ ìë™ìœ¼ë¡œ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì—¬ ì¬ì‹œë„í•©ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Attempt 1                                 â”‚
â”‚  1. CodeGenerator.generate()               â”‚
â”‚  2. Validator.validate()                   â”‚
â”‚  3. Sandbox.execute()                      â”‚
â”‚  â†’ ì„±ê³µ ì‹œ ë°˜í™˜, ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        (ì—ëŸ¬ ë°œìƒ) â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Attempt 2                                 â”‚
â”‚  1. CodeGenerator.generate_with_fix()      â”‚
â”‚     (ì—ëŸ¬ ë©”ì‹œì§€ + ì´ì „ ì½”ë“œ ì „ë‹¬)          â”‚
â”‚  2. Validator.validate()                   â”‚
â”‚  3. Sandbox.execute()                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ ì‚¬ìš© ì˜ˆì‹œ

```python
from AnalysisAgent.src import AnalysisAgent

agent = AnalysisAgent()

# DataFramesë¡œ ë¶„ì„
result = agent.analyze_dataframes(
    query="ê° ì¼€ì´ìŠ¤ë³„ HR í‰ê· ì„ êµ¬í•´ì¤˜",
    dataframes={
        "signals": signals_dict,
        "cohort": cohort_df
    }
)

# DataContextë¡œ ë¶„ì„ (Orchestratorì—ì„œ ì‚¬ìš©)
result = agent.analyze(
    query="ì‹¬ë°•ìˆ˜ í‰ê· ì„ êµ¬í•´ì¤˜",
    data_context=data_context
)
```

---

## ğŸ“ íŒŒì¼ êµ¬ì¡°

```
AnalysisAgent/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ agent.py              # ë©”ì¸ AnalysisAgent í´ë˜ìŠ¤
â”‚   â”œâ”€â”€ config.py             # ì„¤ì •
â”‚   â”‚
â”‚   â”œâ”€â”€ context/              # Phase 1: Context Building
â”‚   â”‚   â”œâ”€â”€ builder.py        # ContextBuilder
â”‚   â”‚   â””â”€â”€ schema.py         # ColumnInfo, DataFrameSchema
â”‚   â”‚
â”‚   â”œâ”€â”€ planner/              # Phase 2: Planning
â”‚   â”‚   â”œâ”€â”€ planner.py        # AnalysisPlanner
â”‚   â”‚   â””â”€â”€ prompts.py        # ê³„íš í”„ë¡¬í”„íŠ¸
â”‚   â”‚
â”‚   â”œâ”€â”€ executor/             # Phase 3: Execution
â”‚   â”‚   â”œâ”€â”€ executor.py       # StepExecutor
â”‚   â”‚   â””â”€â”€ router.py         # ExecutionRouter
â”‚   â”‚
â”‚   â”œâ”€â”€ code_gen/             # ì½”ë“œ ìƒì„± ì—”ì§„
â”‚   â”‚   â”œâ”€â”€ engine.py         # CodeExecutionEngine
â”‚   â”‚   â”œâ”€â”€ generator.py      # CodeGenerator
â”‚   â”‚   â”œâ”€â”€ validator.py      # CodeValidator (ë³€ìˆ˜ ê²€ì¦ í¬í•¨)
â”‚   â”‚   â”œâ”€â”€ sandbox.py        # SandboxExecutor
â”‚   â”‚   â””â”€â”€ prompts.py        # ì½”ë“œ ìƒì„± í”„ë¡¬í”„íŠ¸
â”‚   â”‚
â”‚   â”œâ”€â”€ tools/                # Tool ì‹œìŠ¤í…œ (í™•ì¥ìš©)
â”‚   â”‚   â”œâ”€â”€ base.py           # BaseTool
â”‚   â”‚   â””â”€â”€ registry.py       # ToolRegistry
â”‚   â”‚
â”‚   â”œâ”€â”€ results/              # Phase 4: Result Assembly
â”‚   â”‚   â””â”€â”€ store.py          # ResultStore (ìºì‹±)
â”‚   â”‚
â”‚   â””â”€â”€ models/               # Pydantic ëª¨ë¸
â”‚       â”œâ”€â”€ io.py             # StepInput, StepOutput
â”‚       â”œâ”€â”€ context.py        # ExecutionContext
â”‚       â””â”€â”€ code_gen.py       # CodeRequest, GenerationResult
â”‚
â””â”€â”€ tests/
    â””â”€â”€ test_analysis_agent.py
```

---

## âš™ï¸ ì„¤ì •

```python
from AnalysisAgent.src import create_config

config = create_config(
    use_llm_planning=True,     # LLM ê¸°ë°˜ ê³„íš ìˆ˜ë¦½
    use_cache=True,            # ê²°ê³¼ ìºì‹±
    code_gen_max_retries=3,    # ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜
    sandbox_timeout=30,        # ì‹¤í–‰ íƒ€ì„ì•„ì›ƒ (ì´ˆ)
)

agent = AnalysisAgent(config=config)
```

---

## ğŸ”’ ë³´ì•ˆ

### ê¸ˆì§€ íŒ¨í„´
- `eval()`, `exec()`, `__import__()`
- `os.system()`, `subprocess`
- íŒŒì¼ I/O (`open()`, `read()`, `write()`)
- ë„¤íŠ¸ì›Œí¬ ìš”ì²­

### ë³€ìˆ˜ ê²€ì¦ (v2.0 ì¶”ê°€)
- ìƒì„±ëœ ì½”ë“œê°€ `available_variables`ì— ì •ì˜ëœ ë³€ìˆ˜ë§Œ ì°¸ì¡°í•˜ëŠ”ì§€ ê²€ì¦
- `signals` vs `df` í˜¼ë™ ë°©ì§€
- ì •ì˜ë˜ì§€ ì•Šì€ ë³€ìˆ˜ ì‚¬ìš© ì‹œ ì—ëŸ¬
