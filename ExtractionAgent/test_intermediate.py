#!/usr/bin/env python3
"""
ExtractionAgent ì¤‘ê¸‰ í…ŒìŠ¤íŠ¸ - 2ê°œ í…Œì´ë¸” JOIN ì˜ˆì œ 5ê°œ
"""

import sys
import os

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from dotenv import load_dotenv
load_dotenv()

from ExtractionAgent.src.extraction_agent import ExtractionAgent


def main():
    print("\n" + "=" * 70)
    print("ğŸš€ ExtractionAgent ì¤‘ê¸‰ í…ŒìŠ¤íŠ¸ - 2 Table JOIN")
    print("=" * 70)
    
    agent = ExtractionAgent()
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ì˜ˆì œ 1: operations + vitals (op_idë¡œ JOIN)
    # ìˆ˜ìˆ  ì •ë³´ì™€ í•´ë‹¹ ìˆ˜ìˆ  ì¤‘ ì¸¡ì •ëœ ë°”ì´íƒˆ ì¡°íšŒ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n\n" + "=" * 70)
    print("ğŸ“Œ [ì˜ˆì œ 1] operations + vitals JOIN (op_id ê¸°ì¤€)")
    print("   â†’ ê° ìˆ˜ìˆ (op_id)ë³„ë¡œ í™˜ì ë‚˜ì´ì™€ ë°”ì´íƒˆ ê¸°ë¡ ìˆ˜ ì¡°íšŒ")
    print("=" * 70)
    
    result = agent.extract(
        query="operations í…Œì´ë¸”ê³¼ vitals í…Œì´ë¸”ì„ op_idë¡œ ì¡°ì¸í•´ì„œ, ê° ìˆ˜ìˆ ë³„ë¡œ í™˜ì ë‚˜ì´ì™€ ë°”ì´íƒˆ ê¸°ë¡ ê°œìˆ˜ë¥¼ ë³´ì—¬ì¤˜. ìƒìœ„ 10ê°œë§Œ.",
        result_limit=10
    )
    
    if result["success"] and result["data"] is not None:
        print(f"\nâœ… {result['row_count']}í–‰ ë°˜í™˜")
        print(f"ğŸ“Š ìƒì„±ëœ SQL:\n{result['sql']}\n")
        print(result["data"])
    else:
        print(f"\nâŒ ì‹¤íŒ¨: {result.get('error')}")
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ì˜ˆì œ 2: operations + labs (subject_idë¡œ JOIN)
    # í™˜ìì˜ ìˆ˜ìˆ  ì •ë³´ì™€ ê²€ì‚¬ ê²°ê³¼ ì¡°íšŒ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n\n" + "=" * 70)
    print("ğŸ“Œ [ì˜ˆì œ 2] operations + labs JOIN (subject_id ê¸°ì¤€)")
    print("   â†’ í™˜ìë³„ë¡œ ìˆ˜ìˆ  ì •ë³´ì™€ ê²€ì‚¬ í•­ëª© ì¡°íšŒ")
    print("=" * 70)
    
    result = agent.extract(
        query="operations í…Œì´ë¸”ê³¼ labs í…Œì´ë¸”ì„ subject_idë¡œ ì¡°ì¸í•´ì„œ, í™˜ì ë‚˜ì´, ì„±ë³„, ê²€ì‚¬ í•­ëª©(item_name)ì„ ë³´ì—¬ì¤˜. ìƒìœ„ 10ê°œë§Œ.",
        result_limit=10
    )
    
    if result["success"] and result["data"] is not None:
        print(f"\nâœ… {result['row_count']}í–‰ ë°˜í™˜")
        print(f"ğŸ“Š ìƒì„±ëœ SQL:\n{result['sql']}\n")
        print(result["data"])
    else:
        print(f"\nâŒ ì‹¤íŒ¨: {result.get('error')}")
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ì˜ˆì œ 3: labs + diagnosis (subject_idë¡œ JOIN)
    # í™˜ìì˜ ê²€ì‚¬ ê²°ê³¼ì™€ ì§„ë‹¨ ì½”ë“œ ì¡°íšŒ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n\n" + "=" * 70)
    print("ğŸ“Œ [ì˜ˆì œ 3] labs + diagnosis JOIN (subject_id ê¸°ì¤€)")
    print("   â†’ í™˜ìë³„ë¡œ ê²€ì‚¬ í•­ëª©ê³¼ ì§„ë‹¨ ì½”ë“œ ì¡°íšŒ")
    print("=" * 70)
    
    result = agent.extract(
        query="labs í…Œì´ë¸”ê³¼ diagnosis í…Œì´ë¸”ì„ subject_idë¡œ ì¡°ì¸í•´ì„œ, subject_id, ê²€ì‚¬ í•­ëª©(item_name), ì§„ë‹¨ì½”ë“œ(icd10_cm)ë¥¼ ë³´ì—¬ì¤˜. ìƒìœ„ 10ê°œë§Œ.",
        result_limit=10
    )
    
    if result["success"] and result["data"] is not None:
        print(f"\nâœ… {result['row_count']}í–‰ ë°˜í™˜")
        print(f"ğŸ“Š ìƒì„±ëœ SQL:\n{result['sql']}\n")
        print(result["data"])
    else:
        print(f"\nâŒ ì‹¤íŒ¨: {result.get('error')}")
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ì˜ˆì œ 4: medications + diagnosis (subject_idë¡œ JOIN)
    # í™˜ìì˜ íˆ¬ì•½ ì •ë³´ì™€ ì§„ë‹¨ ì½”ë“œ ì¡°íšŒ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n\n" + "=" * 70)
    print("ğŸ“Œ [ì˜ˆì œ 4] medications + diagnosis JOIN (subject_id ê¸°ì¤€)")
    print("   â†’ í™˜ìë³„ë¡œ íˆ¬ì•½í•œ ì•½ë¬¼ê³¼ ì§„ë‹¨ ì½”ë“œ ì¡°íšŒ")
    print("=" * 70)
    
    result = agent.extract(
        query="medications í…Œì´ë¸”ê³¼ diagnosis í…Œì´ë¸”ì„ subject_idë¡œ ì¡°ì¸í•´ì„œ, subject_id, ì•½ë¬¼ëª…(drug_name), ì§„ë‹¨ì½”ë“œ(icd10_cm)ë¥¼ ë³´ì—¬ì¤˜. ìƒìœ„ 10ê°œë§Œ.",
        result_limit=10
    )
    
    if result["success"] and result["data"] is not None:
        print(f"\nâœ… {result['row_count']}í–‰ ë°˜í™˜")
        print(f"ğŸ“Š ìƒì„±ëœ SQL:\n{result['sql']}\n")
        print(result["data"])
    else:
        print(f"\nâŒ ì‹¤íŒ¨: {result.get('error')}")
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ì˜ˆì œ 5: operations + medications (subject_idë¡œ JOIN)
    # ìˆ˜ìˆ  í™˜ìì˜ íˆ¬ì•½ ì •ë³´ ì¡°íšŒ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n\n" + "=" * 70)
    print("ğŸ“Œ [ì˜ˆì œ 5] operations + medications JOIN (subject_id ê¸°ì¤€)")
    print("   â†’ ìˆ˜ìˆ  í™˜ìë³„ë¡œ ì–´ë–¤ ì•½ë¬¼ì„ íˆ¬ì•½ë°›ì•˜ëŠ”ì§€ ì¡°íšŒ")
    print("=" * 70)
    
    result = agent.extract(
        query="operations í…Œì´ë¸”ê³¼ medications í…Œì´ë¸”ì„ subject_idë¡œ ì¡°ì¸í•´ì„œ, í™˜ìë³„ë¡œ ìˆ˜ìˆ  ë‚ ì§œ(opdate), ì•½ë¬¼ëª…(drug_name), íˆ¬ì•½ ê²½ë¡œ(route)ë¥¼ ë³´ì—¬ì¤˜. ìƒìœ„ 10ê°œë§Œ.",
        result_limit=10
    )
    
    if result["success"] and result["data"] is not None:
        print(f"\nâœ… {result['row_count']}í–‰ ë°˜í™˜")
        print(f"ğŸ“Š ìƒì„±ëœ SQL:\n{result['sql']}\n")
        print(result["data"])
    else:
        print(f"\nâŒ ì‹¤íŒ¨: {result.get('error')}")
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ìš”ì•½
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n\n" + "=" * 70)
    print("ğŸ“‹ í…ŒìŠ¤íŠ¸ ìš”ì•½")
    print("=" * 70)
    print("""
    ì˜ˆì œ 1: operations + vitals    (op_idë¡œ JOIN)
    ì˜ˆì œ 2: operations + labs      (subject_idë¡œ JOIN)
    ì˜ˆì œ 3: labs + diagnosis       (subject_idë¡œ JOIN)
    ì˜ˆì œ 4: medications + diagnosis (subject_idë¡œ JOIN)
    ì˜ˆì œ 5: operations + medications (subject_idë¡œ JOIN)
    """)
    print("=" * 70)
    print("âœ… ì¤‘ê¸‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")
    print("=" * 70)


if __name__ == "__main__":
    main()


