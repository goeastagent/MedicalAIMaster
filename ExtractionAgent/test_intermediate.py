#!/usr/bin/env python3
"""
ExtractionAgent ì¤‘ê¸‰ í…ŒìŠ¤íŠ¸ - LangGraph ì›Œí¬í”Œë¡œìš° + Self-Correction Loop

ì‹¤ì œ DB í…Œì´ë¸”:
- clinical_data_table: í™˜ì/ìˆ˜ìˆ  ì •ë³´ (6,388í–‰)
  - caseid, subjectid, age, sex, weight, height, bmi
  - department, optype, opname, dx
  - preop_* (ìˆ˜ìˆ  ì „ ê²€ì‚¬), intraop_* (ìˆ˜ìˆ  ì¤‘)
  
- lab_data_table: ê²€ì‚¬ ê²°ê³¼ (928,448í–‰)
  - caseid (FK), dt (ì‹œê°„), name (ê²€ì‚¬ëª…), result (ê²°ê³¼ê°’)
  - name: alb, alt, ast, bun, cr, gluc, hb, k, na, lac, plt, etc.

JOIN Key: caseid
"""

import sys
import os

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from dotenv import load_dotenv
load_dotenv()

from ExtractionAgent.src.agents.graph import build_extraction_graph


def run_query(query: str, description: str = ""):
    """ë‹¨ì¼ ì¿¼ë¦¬ ì‹¤í–‰"""
    print(f"\n\n{'=' * 70}")
    print(f"ğŸ“Œ {description}")
    print(f"{'=' * 70}")
    print(f"   Query: {query[:80]}...")
    
    # ê·¸ë˜í”„ ë¹Œë“œ
    app = build_extraction_graph()
    
    # ì´ˆê¸° ìƒíƒœ
    initial_state = {
        "user_query": query,
        "semantic_context": {},
        "sql_plan": {},
        "generated_sql": None,
        "execution_result": None,
        "output_file_path": None,
        "error": None,
        "logs": [],
        "retry_count": 0,
        "max_retries": 3,
        "sql_history": []
    }
    
    # ì‹¤í–‰
    try:
        final_state = app.invoke(initial_state)
        
        # ê²°ê³¼ ìš”ì•½
        print(f"\n{'â”€' * 70}")
        print(f"ğŸ“Š ê²°ê³¼ ìš”ì•½")
        print(f"{'â”€' * 70}")
        
        if final_state.get("error"):
            print(f"   âŒ ì—ëŸ¬: {final_state['error'][:100]}...")
        else:
            result = final_state.get("execution_result")
            if result:
                print(f"   âœ… ì„±ê³µ: {len(result)}í–‰ ë°˜í™˜")
                
                sql = final_state.get('generated_sql', 'N/A')
                print(f"\n   ğŸ“„ ìƒì„±ëœ SQL:")
                for line in sql.split('\n'):
                    print(f"      {line}")
                
                print(f"\n   ğŸ“ ì €ì¥ íŒŒì¼: {final_state.get('output_file_path', 'N/A')}")
                
                # ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ìƒìœ„ 10í–‰)
                if len(result) > 0:
                    print(f"\n   ğŸ“‹ ë°ì´í„° (ìƒìœ„ 10ê°œ):")
                    columns = list(result[0].keys())
                    
                    # í—¤ë” ì¶œë ¥
                    header = " | ".join([f"{col[:12]:<12}" for col in columns])
                    print(f"      {header}")
                    print(f"      {'-' * len(header)}")
                    
                    # ë°ì´í„° ì¶œë ¥ (ìƒìœ„ 10ê°œ)
                    for i, row in enumerate(result[:10]):
                        values = [str(v)[:12] if v is not None else 'NULL' for v in row.values()]
                        row_str = " | ".join([f"{v:<12}" for v in values])
                        print(f"      {row_str}")
                    
                    if len(result) > 10:
                        print(f"      ... ({len(result) - 10}ê°œ ë” ìˆìŒ)")
            else:
                print(f"   âš ï¸ ê²°ê³¼ ì—†ìŒ")
        
        # Self-Correction íˆìŠ¤í† ë¦¬
        sql_history = final_state.get("sql_history", [])
        retry_count = final_state.get("retry_count", 0)
        if sql_history:
            print(f"\n   ğŸ”„ Self-Correction íˆìŠ¤í† ë¦¬:")
            for h in sql_history:
                print(f"      â€¢ Attempt {h['attempt']}: {h['error'][:50]}...")
            if not final_state.get("error"):
                print(f"      â€¢ Attempt {retry_count + 1}: âœ… Success")
        
        return final_state
        
    except Exception as e:
        print(f"\n   âŒ ì‹¤í–‰ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {e}")
        import traceback
        traceback.print_exc()
        return None


def main():
    print("\n" + "=" * 70)
    print("ğŸš€ ExtractionAgent ì¤‘ê¸‰ í…ŒìŠ¤íŠ¸ - JOIN & Aggregation")
    print("   (Self-Correction Loop í™œì„±í™”)")
    print("=" * 70)
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ì˜ˆì œ 1: í™˜ìë³„ ê²€ì‚¬ ê¸°ë¡ ìˆ˜ (caseidë¡œ JOIN)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    run_query(
        query="ìˆ˜ìˆ case ë³„ë¡œ subjectid, ìˆ˜ìˆ  ì¼€ì´ìŠ¤, ë‚˜ì´, ì„±ë³„, ê²€ì‚¬ ê¸°ë¡ ê°œìˆ˜ë¥¼ ë³´ì—¬ì¤˜. ìƒìœ„ 10ê°œë§Œ.",
        description="[ì˜ˆì œ 1] JOIN + GROUP BY - í™˜ìë³„ ê²€ì‚¬ ê¸°ë¡ ìˆ˜"
    )
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ì˜ˆì œ 2: íŠ¹ì • ê²€ì‚¬ ê²°ê³¼ì™€ í™˜ì ì •ë³´
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    run_query(
        query="caseid, ë‚˜ì´, ì„±ë³„, ê²€ì‚¬ê²°ê³¼(result)ë¥¼ ë³´ì—¬ì¤˜. ìƒìœ„ 10ê°œë§Œ.",
        description="[ì˜ˆì œ 2] JOIN + WHERE - í˜ˆìƒ‰ì†Œ(hb) ê²€ì‚¬ ê²°ê³¼"
    )
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ì˜ˆì œ 3: ë¶€ì„œë³„ í‰ê·  BMI
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    run_query(
        query="ë¶€ì„œ(department)ë³„ë¡œ í‰ê·  BMIë¥¼ ê³„ì‚°í•´ì„œ ë³´ì—¬ì¤˜. BMIê°€ ìˆëŠ” í™˜ìë§Œ.",
        description="[ì˜ˆì œ 3] GROUP BY - ë¶€ì„œë³„ í‰ê·  BMI"
    )
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ì˜ˆì œ 4: ì –ì‚°(lac) ê²€ì‚¬ ê²°ê³¼ ìƒìœ„ 10ëª…
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    run_query(
        query="lab_data_tableì—ì„œ ì –ì‚°(name='lac') ê²€ì‚¬ë¥¼ ë°›ì€ í™˜ìë“¤ì„, clinical_data_tableê³¼ caseidë¡œ ì¡°ì¸í•´ì„œ, caseid, ë‚˜ì´, ì„±ë³„, ì –ì‚° ê²°ê³¼ê°’ì„ ê²°ê³¼ê°’ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ 10ê°œ ë³´ì—¬ì¤˜.",
        description="[ì˜ˆì œ 4] JOIN + ORDER BY - ì –ì‚° ê²€ì‚¬ ê²°ê³¼ ë†’ì€ ìˆœì„œ"
    )
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ì˜ˆì œ 5: ì„±ë³„ì— ë”°ë¥¸ í‰ê·  ìˆ˜ìˆ  ì „ í—¤ëª¨ê¸€ë¡œë¹ˆ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    run_query(
        query="clinical_data_tableì—ì„œ ì„±ë³„(sex)ë³„ë¡œ ìˆ˜ìˆ  ì „ í—¤ëª¨ê¸€ë¡œë¹ˆ(preop_hb)ì˜ í‰ê· ê°’ì„ ë³´ì—¬ì¤˜.",
        description="[ì˜ˆì œ 5] GROUP BY - ì„±ë³„ í‰ê·  ìˆ˜ìˆ  ì „ í—¤ëª¨ê¸€ë¡œë¹ˆ"
    )
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ìš”ì•½
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n\n" + "=" * 70)
    print("ğŸ“‹ í…ŒìŠ¤íŠ¸ ìš”ì•½")
    print("=" * 70)
    print("""
    ì˜ˆì œ 1: JOIN + GROUP BY - í™˜ìë³„ ê²€ì‚¬ ê¸°ë¡ ìˆ˜
    ì˜ˆì œ 2: JOIN + WHERE    - íŠ¹ì • ê²€ì‚¬(hb) ê²°ê³¼ì™€ í™˜ì ì •ë³´
    ì˜ˆì œ 3: GROUP BY        - ë¶€ì„œë³„ í‰ê·  BMI
    ì˜ˆì œ 4: JOIN + ORDER BY - ì –ì‚° ê²€ì‚¬ ê²°ê³¼ ë†’ì€ ìˆœì„œ
    ì˜ˆì œ 5: GROUP BY        - ì„±ë³„ í‰ê·  ìˆ˜ìˆ  ì „ í—¤ëª¨ê¸€ë¡œë¹ˆ
    """)
    print("=" * 70)
    print("âœ… ì¤‘ê¸‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")
    print("=" * 70)


if __name__ == "__main__":
    main()
